{% extends "layout.html" %} {% block title %}Subscribe to Courses | LearnHub{%
endblock %} {% block content %}

<section class="subscription-hero">
  <h1>Choose Courses to Subscribe</h1>
  <p>Subscribe to individual courses and unlock full access instantly.</p>
</section>

<section class="plans-section">
  <div class="container plans-grid">
    {% for course in courses %}
    <div class="plan-card">
      <h2>{{ course.title }}</h2>

      <p class="desc">{{ course.description }}</p>

      <p class="info">
        Duration: {{ course.duration_weeks }} weeks
        <br />
        Category: {{ course.category }}
      </p>

      <button
        class="cta-button primary subscribe-btn"
        data-course-id="{{ course.id }}"
      >
        Subscribe to this course
      </button>
    </div>
    {% endfor %}
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`
    const parts = value.split(`; ${name}=`)
    if (parts.length === 2) return parts.pop().split(";").shift()
  }
  document.querySelectorAll(".subscribe-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const courseId = btn.dataset.courseId

      // Step 1: check login
      const loginCheck = await fetch("/api/check-login")
      const isLoggedIn = (await loginCheck.json()).logged_in

      if (!isLoggedIn) {
        Swal.fire({
          icon: "warning",
          title: "Please log in first",
          confirmButtonText: "Go to Login",
        }).then(() => (window.location.href = "/login"))
        return
      }

      const csrf = getCookie("csrf_access_token")

      // Step 2: confirm subscription
      Swal.fire({
        title: "Subscribe to this course?",
        text: "You will get full access after subscribing.",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, subscribe",
      }).then(async (result) => {
        if (!result.isConfirmed) return

        const res = await fetch(`/api/subscribe/${courseId}`, {
          method: "POST",
          credentials: "include",
          headers: {
            "X-CSRF-TOKEN": csrf,
          },
        })

        const data = await res.json()

        if (data.success) {
          Swal.fire({
            title: "Subscription Activated!",
            text: "You now have access to this course.",
            icon: "success",
          })
        } else {
          Swal.fire({
            icon: "error",
            title: "Unable to Subscribe",
            text: data.error || "Please try again later.",
          })
        }
      })
    })
  })
</script>

{% endblock %}
